var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};define(["require","exports","lib/createts/event/Signal1","lib/easelts/display/Container","app/util/BindValue","lib/temple/utils/Bounds","./NodeConnection","./ArticleNode","../bubble/BubbleEmitter","lib/zynga/Scroller","app/util/PlatformProfiler","app/data/DataManager","app/config/CanvasSettings","../bubble/config/SmallBubbleConfig","./AnchorNode","app/util/StageProvider","lib/easelts/geom/Size","lib/createts/utils/Ticker","lib/temple/utils/types/ArrayUtils"],function(a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s){var t=function(a){function b(){var b=this;a.call(this,"100%",0,0,"50%"),this.signals={articleSelected:new c,requestNewArticles:new c},this._REQUEST_NEW_ARTICLES_THRESHOLD=1e3,this._isMobile=!1,this.scrollSpeedBounds=new f(50,-50),this._scrollerPadding=0,this._NODE_MARGIN=300,this._showAnchorNodes=!1,this._showConnections=!1,this._connectionContainer=new d,this._smallBubbleContainer=new d,this._nodeContainer=new d,this._connections=[],this._nodeMap={},this._allNodes=[],this._activeNodes=[],this._currentArticles=[],this._currentArticleList=null,this._currentCategory=null,this._stage=null,this._smallEmitter=null,this._smallEmitterTargetNode=null,this._previousScrollerLeft=0,this._mouseIsDown=!1,this._userInitiatedScroll=!1,this._scrollerNodesWidth=0,this._nodeSize=0,this._nodeSizeHalf=0,this._nodeSizePow=0,this.handleNodeMouseOver=function(a){b._smallEmitterTargetNode=a.target,b.updateEmitterPosition(),b._smallEmitter.burst(15),b._smallEmitter.startEmitting(1200)},this.handleNodeClick=function(a){var c=a.target;b.signals.articleSelected.emit(c.data)},this.handleNodeMouseOut=function(a){b._smallEmitterTargetNode=null,b._smallEmitter.stopEmitting()},this.init()}return __extends(b,a),b.prototype.init=function(){this._isMobile=k.getInstance().isMobile,this.addChild(this._smallBubbleContainer),this.addChild(this._nodeContainer),this._showConnections&&this.addChild(this._connectionContainer),this.enableMouseInteraction(),this._nodeContainer.enableMouseInteraction(),this._smallEmitter=new i(l.getInstance().smallBubblePool,m.smallBubbleEmitterChance,new n,this._smallBubbleContainer),this._smallEmitter.width=50,this._smallEmitter.useAutoUpdate=!1,this.addChild(this._smallEmitter),m.useScrollCenterOffset||(this._scrollerPadding=this._nodeSize),this.scrollSpeedBinding=new e(0),this.scrollIndexBinding=new e(0),this._nodeSize=m.nodeSize,this._nodeSizeHalf=.5*this._nodeSize,this._nodeSizePow=this._nodeSize*this._nodeSize},b.prototype.getOrCreateNode=function(a){var b=this._nodeMap[a.slug];return b&&b.data==a?b:this.createNode(a)},b.prototype.createNode=function(a){var b=new h(a,this._nodeSize);b.x=Math.random()*this.parent.width,b.useDrift=!0,b.addEventListener("mouseover",this.handleNodeMouseOver),b.addEventListener("mouseout",this.handleNodeMouseOut),b.addEventListener("click",this.handleNodeClick),b.visible=!1,this._allNodes.push(b),this._nodeMap[a.slug]=b,this._nodeContainer.addChild(b);var c=new o;return m.useRandomAnchorOffset?c.baseY=Math.round(140*Math.random()-60):c.baseY=20,c.x=b.x,c.y=c.baseY,this.addConnection(b,c),this._showAnchorNodes&&this._connectionContainer.addChild(c),b},b.prototype.start=function(){this._stage=p.getStage(),this._stage.addEventListener("stagemousedown",this.onMouseDown.bind(this)),this._stage.addEventListener("stagemousemove",this.onMouseMove.bind(this)),this._stage.addEventListener("stagemouseup",this.onMouseUp.bind(this));var a={scrollingX:!0,scrollingY:!1};m.useScrollSnapping&&(a.snapping=!0),this._scroller=new j(this.onScrollerChange.bind(this),a),m.useScrollSnapping&&this._scroller.setSnapSize(this._NODE_MARGIN,this._NODE_MARGIN),this._stage.resizeSignal.connect(this.onStageResize.bind(this)),this.onStageResize(new q(this._stage.width,this._stage.height)),r.getInstance().tickSignal.connect(this.update.bind(this))},b.prototype.updateArticles=function(a){var b;b=a?a:l.getInstance().articleModel.homeArticleList;var c=b.articles,d=s.getUniqueFirst(this._currentArticles,c),e=s.getUniqueFirst(c,this._currentArticles);if(0!=d.length||0!=e.length){for(var f=0;f<d.length;f++)this._nodeMap[d[f].slug].deactivate();this._activeNodes=[];for(var f=0;f<c.length;f++){var g=this.getOrCreateNode(c[f]);g.toggleCategoryText(null==a),g.anchorNode.x=200+f*this._NODE_MARGIN,g.activate(),this._activeNodes.push(g)}m.useScrollCenterOffset?(this._scrollerPadding=.5*this._stage.width,this._scrollerNodesWidth=(this._activeNodes.length-1)*this._NODE_MARGIN+this._stage.width):(this._scrollerPadding=this._nodeSize,this._scrollerNodesWidth=(this._activeNodes.length-1)*this._NODE_MARGIN+2*this._nodeSize),this._userInitiatedScroll=!1,this._scroller.setDimensions(this.parent.width,0,this._scrollerNodesWidth,0),this._scroller.scrollTo(0,0,!0),this._currentCategory!=a&&this._scroller.scrollTo(0,0,!0),this._currentArticles=c.slice(0),this._currentArticleList=b,this._currentCategory=a}},b.prototype.reset=function(){this._currentArticles=[],this._currentArticleList=null,this._currentCategory=null,this._nodeMap={},this._allNodes=[],this._activeNodes=[];for(var a=this._nodeContainer.getNumChildren()-1;a>=0;a--)this._nodeContainer.getChildAt(a).destruct()},b.prototype.activateNodes=function(){for(var a=0;a<this._activeNodes.length;a++)this._activeNodes[a].activate()},b.prototype.deactivateNodes=function(){for(var a=0;a<this._activeNodes.length;a++)this._activeNodes[a].deactivate()},b.prototype.addConnection=function(a,b){var c=new g(a,b);return this._showConnections&&(this._connectionContainer.addChild(c),this._connections.push(c)),c},b.prototype.update=function(a){if(0!=this._allNodes.length){for(var b=[],c=.5*this.stage.height,d=0;d<this._allNodes.length;d++){var e=this._allNodes[d];e.isActive&&(e.applyForce(a),e.x>-this._nodeSize&&e.x<this.width+this._nodeSize&&e.y>-c-e.height&&e.y<c+e.height?(e.visible=!0,b.push(e)):e.visible=!1)}b.sort(function(a,b){return a.x-b.x});for(var d=0;d<b.length;d++){if(e=b[d],d>0)for(var f=0;3>f;f++){var g=b[d-1],h=e.x-g.x,i=e.y-g.y,j=h*h+i*i;if(j<this._nodeSizePow){var k=Math.sqrt(j),m=Math.atan2(i,h),n=.5*(this._nodeSize-k),o=Math.cos(m)*n,p=Math.sin(m)*n;e.x+=o,e.y+=p,g.x-=o,g.y-=p}}for(var q=0;q<this._smallBubbleContainer.getNumChildren();q++){var r=this._smallBubbleContainer.getChildAt(q),h=r.x-e.x,i=r.y-e.y,s=this._nodeSizeHalf+27;if(s*s>h*h+i*i){var t=Math.max(0,(r.y-e.y)/(this._nodeSizeHalf+20)),m=Math.atan2(i,h),n=this._nodeSizeHalf+r.width+r.nodeAttractionOffset,u=e.x+Math.cos(m)*n-r.x,v=e.y+Math.sin(m)*n-r.y;r.vx+=.2*u*a,r.vy+=.01*v*a,r.x+=u*t*a,r.y+=v*t*a}}e.checkMouseOver()}this.updateEmitterPosition(),this._smallEmitter.update(a);var w=l.getInstance().globalBubbleVx;if(l.getInstance().globalBubbleVx+=(.95*w-w)*a,this._showConnections)for(var d=0;d<this._connections.length;d++)this._connections[d].drawLine();0!=this.scrollSpeedBinding.getValue()&&this._scroller.scrollBy(this.scrollSpeedBinding.getValue()*a,0,!1)}},b.prototype.doSmallBurst=function(a,b,c){void 0===c&&(c=10),this._smallEmitter.x=a,this._smallEmitter.y=b,this._smallEmitter.burst(c)},b.prototype.updateEmitterPosition=function(){if(this._smallEmitterTargetNode){var a=this._stage.mouseX-this._smallEmitterTargetNode.x;this._smallEmitter.x=this._smallEmitterTargetNode.x+Math.min(10,Math.max(a,-10)),this._smallEmitter.y=this._smallEmitterTargetNode.y+.5*this._smallEmitterTargetNode.height*this._smallEmitterTargetNode.scaleX-15}},b.prototype.onMouseDown=function(a){a.stageY>this._stage.height-110||(this._userInitiatedScroll=!0,this._scroller.doTouchStart([{pageX:a.stageX,pageY:a.stageY}],a.timeStamp),this._mouseIsDown=!0)},b.prototype.onMouseMove=function(a){this._mouseIsDown&&(this._scroller.doTouchMove([{pageX:a.stageX,pageY:a.stageY}],a.timeStamp),this._mouseIsDown=!0)},b.prototype.onMouseUp=function(a){this._mouseIsDown&&(this._scroller.doTouchEnd(a.timeStamp),this._mouseIsDown=!1)},b.prototype.onScrollerChange=function(a,b,c){var d;d=!m.useScrollCenterOffset&&this._stage.width>this._scrollerNodesWidth?.5*(this._stage.width-this._scrollerNodesWidth)+this._scrollerPadding:this._scrollerPadding;for(var e=0;e<this._activeNodes.length;e++)this._activeNodes[e].anchorNode.x=d+e*this._NODE_MARGIN-a;this._userInitiatedScroll&&(l.getInstance().globalBubbleVx+=.05*(this._previousScrollerLeft-a)),this._previousScrollerLeft=a;var f=Math.min(this._activeNodes.length-1,Math.max(0,Math.round(a/this._NODE_MARGIN)));this.scrollIndexBinding.setValue(f),this._currentArticleList&&this._activeNodes.length<this._currentArticleList.totalItems&&this._scrollerNodesWidth>this.stage.width&&this._scrollerNodesWidth-this._stage.width-a-this._REQUEST_NEW_ARTICLES_THRESHOLD<0&&this.signals.requestNewArticles.emit(this._activeNodes.length)},b.prototype.onStageResize=function(a){m.useScrollCenterOffset&&(this._scrollerPadding=.5*a.width,this._scrollerNodesWidth=(this._activeNodes.length-1)*this._NODE_MARGIN+a.width),this._scroller.setDimensions(a.width,0,this._scrollerNodesWidth,0)},b}(d);return t});
//# sourceMappingURL=../../../../../../sourcemap/app/page/home-canvas/component/node/NodeContainer.js.map