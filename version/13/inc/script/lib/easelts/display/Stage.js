var __extends=this.__extends||function(a,b){function c(){this.constructor=a}for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d]);c.prototype=b.prototype,a.prototype=new c};define(["require","exports","../../createts/utils/Ticker","./DisplayObject","./Container","../geom/Size","../geom/PointerData","../enum/QualityType","../enum/DisplayType","../event/PointerEvent","../../createts/event/TimeEvent","../../createts/event/Signal"],function(a,b,c,d,e,f,g,h,i,j,k,l){var m=function(a){function b(b){var c=this;a.call(this,"100%","100%",0,0,0,0),this.tickstartSignal=new l,this.tickendSignal=new l,this.drawstartSignal=new l,this.drawendSignal=new l,this.type=1,this._isRunning=!1,this._tickSignalConnection=null,this._fps=60,this._eventListeners=null,this.autoClear=!0,this.canvas=null,this.ctx=null,this.holder=null,this.mouseX=0,this.mouseY=0,this._autoSizeOnWindowResize=!1,this.drawRect=null,this.snapToPixelEnabled=!1,this.mouseInBounds=!1,this.tickOnUpdate=!0,this.mouseMoveOutside=!1,this._pointerData={},this._pointerCount=0,this._primaryPointerID=null,this._mouseOverIntervalID=null,this._nextStage=null,this._prevStage=null,this.update=function(a){if(c.canvas){c.tickOnUpdate&&c.onTick.call(c,a),c.drawstartSignal.emit(),d._snapToPixelEnabled=c.snapToPixelEnabled;var b=c.drawRect,e=c.ctx;e.setTransform(1,0,0,1,0,0),c.autoClear&&(b?e.clearRect(b.x,b.y,b.width,b.height):e.clearRect(0,0,c.canvas.width+1,c.canvas.height+1)),e.save(),c.drawRect&&(e.beginPath(),e.rect(b.x,b.y,b.width,b.height),e.clip()),c.updateContext(e),c.draw(e,!1),e.restore(),c.drawendSignal.emit()}};var e=null;switch(b.tagName){case"CANVAS":this.canvas=b,this.holder=b.parentElement,e=new f(this.canvas.width,this.canvas.height);break;case"DIV":var g=document.createElement("canvas");b.appendChild(g),this.canvas=g,this.holder=b,e=new f(this.holder.offsetWidth,this.holder.offsetHeight),this._autoSizeOnWindowResize=!0;break;default:throw new Error('unsupported element used "'+b.tagName+'"')}this.enableDOMEvents(!0),this.setFps(this._fps),this.ctx=this.canvas.getContext("2d"),this.setQuality(0),this.stage=this,this._autoSizeOnWindowResize&&this.onResize(new f(this.holder.offsetWidth,this.holder.offsetHeight))}return __extends(b,a),Object.defineProperty(b.prototype,"nextStage",{get:function(){return this._nextStage},set:function(a){this._nextStage&&(this._nextStage._prevStage=null),a&&(a._prevStage=this),this._nextStage=a},enumerable:!0,configurable:!0}),b.prototype.setQuality=function(a){switch(a){case 1:this.ctx.mozImageSmoothingEnabled=!1,this.ctx.webkitImageSmoothingEnabled=!1,this.ctx.msImageSmoothingEnabled=!1,this.ctx.imageSmoothingEnabled=!1;break;case 0:this.ctx.mozImageSmoothingEnabled=!0,this.ctx.webkitImageSmoothingEnabled=!0,this.ctx.msImageSmoothingEnabled=!0,this.ctx.imageSmoothingEnabled=!0}},b.prototype.tick=function(a){this.tickEnabled&&(this.tickstartSignal.emit(),this.onTick(a),this.tickendSignal.emit())},b.prototype.clear=function(){if(this.canvas){var a=this.canvas.getContext("2d");a.setTransform(1,0,0,1,0,0),a.clearRect(0,0,this.canvas.width+1,this.canvas.height+1)}},b.prototype.toDataURL=function(a,b){b||(b="image/png");var c,d=this.canvas.getContext("2d"),e=this.canvas.width,f=this.canvas.height;if(a){c=d.getImageData(0,0,e,f);var g=d.globalCompositeOperation;d.globalCompositeOperation="destination-over",d.fillStyle=a,d.fillRect(0,0,e,f)}var h=this.canvas.toDataURL(b);return a&&(d.clearRect(0,0,e+1,f+1),d.putImageData(c,0,0),d.globalCompositeOperation=g),h},b.prototype.enableMouseOver=function(a){var b=this;if(void 0===a&&(a=null),this._mouseOverIntervalID&&(clearInterval(this._mouseOverIntervalID),this._mouseOverIntervalID=null,0==a&&this._testMouseOver(!0)),null==a)a=20;else if(0>=a)return void 0;this.enableMouseInteraction(),this._mouseOverIntervalID=setInterval(function(){b._testMouseOver()},1e3/Math.min(50,a))},b.prototype.enableDOMEvents=function(a){var b=this;void 0===a&&(a=!0);var c,d,e=this._eventListeners;if(!a&&e){for(c in e)d=e[c],d.window.removeEventListener(c,d.fn,!1);this._eventListeners=null}else if(a&&!e&&this.canvas){var f=window.addEventListener?window:document;e=this._eventListeners={},e.mouseup={window:f,fn:function(a){return b._handleMouseUp(a)}},e.mousemove={window:f,fn:function(a){return b._handleMouseMove(a)}},e.mousedown={window:this.canvas,fn:function(a){return b._handleMouseDown(a)}},this._autoSizeOnWindowResize&&(e.resize={window:f,fn:function(a){return b._handleWindowResize(a)}});for(c in e)d=e[c],d.window.addEventListener(c,d.fn,!1)}},b.prototype.clone=function(){var a=new b(null);return this.cloneProps(a),a},b.prototype.toString=function(){return"[Stage (name="+this.name+")]"},b.prototype._getElementRect=function(a){var b;b=a.getBoundingClientRect();var c=(window.pageXOffset||document.scrollLeft||0)-(document.clientLeft||document.body.clientLeft||0),d=(window.pageYOffset||document.scrollTop||0)-(document.clientTop||document.body.clientTop||0),e=window.getComputedStyle?getComputedStyle(a,null):a.currentStyle,f=parseInt(e.paddingLeft)+parseInt(e.borderLeftWidth),g=parseInt(e.paddingTop)+parseInt(e.borderTopWidth),h=parseInt(e.paddingRight)+parseInt(e.borderRightWidth),i=parseInt(e.paddingBottom)+parseInt(e.borderBottomWidth);return{left:b.left+c+f,right:b.right+c-h,top:b.top+d+g,bottom:b.bottom+d-i}},b.prototype._getPointerData=function(a){var b=this._pointerData[a];return b||(b=this._pointerData[a]=new g(0,0),null==this._primaryPointerID&&(this._primaryPointerID=a),(null==this._primaryPointerID||-1==this._primaryPointerID)&&(this._primaryPointerID=a)),b},b.prototype._handleMouseMove=function(a){void 0===a&&(a=window.event),this._handlePointerMove(-1,a,a.pageX,a.pageY)},b.prototype._handlePointerMove=function(a,b,c,d,e){if((!this._prevStage||void 0!==e)&&this.canvas){var f=this._nextStage,g=this._getPointerData(a),h=g.inBounds;this._updatePointerPosition(a,b,c,d),(h||g.inBounds||this.mouseMoveOutside)&&(-1==a&&g.inBounds==!h&&this._dispatchMouseEvent(this,h?"mouseleave":"mouseenter",!1,a,g,b),this._dispatchMouseEvent(this,"stagemousemove",!1,a,g,b),this._dispatchMouseEvent(g.target,"pressmove",!0,a,g,b)),f&&f._handlePointerMove(a,b,c,d,null)}},b.prototype._updatePointerPosition=function(a,b,c,d){var e=this._getElementRect(this.canvas);c-=e.left,d-=e.top;var f=this.canvas.width,g=this.canvas.height;c/=(e.right-e.left)/f,d/=(e.bottom-e.top)/g;var h=this._getPointerData(a);(h.inBounds=c>=0&&d>=0&&f-1>=c&&g-1>=d)?(h.x=c,h.y=d):this.mouseMoveOutside&&(h.x=0>c?0:c>f-1?f-1:c,h.y=0>d?0:d>g-1?g-1:d),h.posEvtObj=b,h.rawX=c,h.rawY=d,a==this._primaryPointerID&&(this.mouseX=h.x,this.mouseY=h.y,this.mouseInBounds=h.inBounds)},b.prototype._handleMouseUp=function(a){this._handlePointerUp(-1,a,!1)},b.prototype._handlePointerUp=function(a,b,c,d){var e=this._nextStage,f=this._getPointerData(a);if(!this._prevStage||void 0!==d){this._dispatchMouseEvent(this,"stagemouseup",!1,a,f,b);var g=null,h=f.target;d||!h&&!e||(g=this._getObjectsUnderPoint(f.x,f.y,null,!0)),g==h&&this._dispatchMouseEvent(h,"click",!0,a,f,b),this._dispatchMouseEvent(h,"pressup",!0,a,f,b),c?(a==this._primaryPointerID&&(this._primaryPointerID=null),delete this._pointerData[a]):f.target=null,e&&e._handlePointerUp(a,b,c,d||g&&this)}},b.prototype._handleMouseDown=function(a){this._handlePointerDown(-1,a,a.pageX,a.pageY)},b.prototype._handlePointerDown=function(a,b,c,d,e){null!=d&&this._updatePointerPosition(a,b,c,d);var f=null,g=this._nextStage,h=this._getPointerData(a);h.inBounds&&this._dispatchMouseEvent(this,"stagemousedown",!1,a,h,b),e||(f=h.target=this._getObjectsUnderPoint(h.x,h.y,null,!0),this._dispatchMouseEvent(h.target,"mousedown",!0,a,h,b)),g&&g._handlePointerDown(a,b,c,d,e||f&&this)},b.prototype._testMouseOver=function(a,b,c){if(!this._prevStage||void 0!==b){var d=this._nextStage;if(!this._mouseOverIntervalID)return void(d&&d._testMouseOver(a,b,c));if(-1==this._primaryPointerID&&(a||this.mouseX!=this._mouseOverX||this.mouseY!=this._mouseOverY||!this.mouseInBounds)){var e,f,g,h=this._getPointerData(-1),i=h.posEvtObj,j=c||i&&i.target==this.canvas,k=null,l=-1,m="";!b&&(a||this.mouseInBounds&&j)&&(k=this._getObjectsUnderPoint(this.mouseX,this.mouseY,null,!0),this._mouseOverX=this.mouseX,this._mouseOverY=this.mouseY);var n=this._mouseOverTarget||[],o=n[n.length-1],p=this._mouseOverTarget=[];for(e=k;e;)p.unshift(e),null!=e.cursor&&(m=e.cursor),e=e.parent;for(this.canvas.style.cursor=m,!b&&c&&(c.canvas.style.cursor=m),f=0,g=p.length;g>f&&p[f]==n[f];f++)l=f;for(o!=k&&this._dispatchMouseEvent(o,"mouseout",!0,-1,h,i),f=n.length-1;f>l;f--)this._dispatchMouseEvent(n[f],"rollout",!1,-1,h,i);for(f=p.length-1;f>l;f--)this._dispatchMouseEvent(p[f],"rollover",!1,-1,h,i);o!=k&&this._dispatchMouseEvent(k,"mouseover",!0,-1,h,i),d&&d._testMouseOver(a,b||k&&this,c||j&&this)}}},b.prototype._handleDoubleClick=function(a,b){var c=null,d=this._nextStage,e=this._getPointerData(-1);b||(c=this._getObjectsUnderPoint(e.x,e.y,null,!0),this._dispatchMouseEvent(c,"dblclick",!0,-1,e,a)),d&&d._handleDoubleClick(a,b||c&&this)},b.prototype._handleWindowResize=function(a){this.onResize(new f(this.holder.offsetWidth,this.holder.offsetHeight))},b.prototype._dispatchMouseEvent=function(a,b,c,d,e,f){if(a&&(c||a.hasEventListener(b))){var g=new j(b,c,!1,e.x,e.y,f,d,d==this._primaryPointerID,e.rawX,e.rawY);a.dispatchEvent(g)}},b.prototype.setFps=function(a){this._fps=a,c.getInstance().setFPS(a)},b.prototype.getFps=function(){return this._fps},b.prototype.start=function(){return this._isRunning?!1:(this.update(new k("tick",0,!1,0,0)),this._tickSignalConnection=c.getInstance().addTickListener(this.update),this._isRunning=!0,!0)},b.prototype.stop=function(){return this._isRunning?(this._tickSignalConnection.dispose(),this._tickSignalConnection=null,setTimeout(this.update,1e3/this._fps),this._isRunning=!1,!0):!1},b.prototype.isRunning=function(){return this._isRunning},b.prototype.onResize=function(b){b.width=b.width+1>>1<<1,b.height=b.height+1>>1<<1,(this.width!=b.width||this.height!=b.height)&&(this.canvas.width=b.width,this.canvas.height=b.height,a.prototype.onResize.call(this,b),this._isRunning||this.update(new k("tick",0,!1,0,0)))},b.prototype.destruct=function(){this.stop(),this.enableDOMEvents(!1),a.prototype.destruct.call(this)},b.EVENT_MOUSE_LEAVE="mouseleave",b.EVENT_MOUSE_ENTER="mouseenter",b.EVENT_STAGE_MOUSE_MOVE="stagemousemove",b}(e);return m});
//# sourceMappingURL=../../../../sourcemap/lib/easelts/display/Stage.js.map